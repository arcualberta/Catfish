@model Catfish.Core.Models.Contents.Fields.SelectField
@using System.Text.Encodings.Web
@using System.Xml.Linq

@Html.HiddenFor(model => model.ModelType)
@Html.HiddenFor(model => model.Id)

@if (Model.Exclude)
    return;

@{

    var options = Model.Options.Select(op =>
            new SelectListItem
            {
                Value = op.Id.ToString(),
                Text = op.OptionText.GetConcatenatedContent(" | "),
            }).ToList();
    options.Insert(0, new SelectListItem());


    if (Model.Options.Where(op => !string.IsNullOrWhiteSpace(op.VisibilityCondition.Value)).Any() == false)
    {
        @Html.DropDownListFor(model => model, options, ViewData)
    }
    else
    {
        //Incorporating the visible-if data attributes for the options if needed

        var selectHtmlContent = Html.DropDownListFor(model => model, options, ViewData);
        string selectHtmlString = "";
        using (var writer = new System.IO.StringWriter())
        {
            selectHtmlContent.WriteTo(writer, HtmlEncoder.Default);
            selectHtmlString = writer.ToString();
            XElement xml = XElement.Parse(selectHtmlString);
            foreach (var op in Model.Options)
            {
                var visibleIfValue = op.VisibilityCondition.Value;
                if (!string.IsNullOrWhiteSpace(visibleIfValue))
                {
                    XElement optionElement = xml.Elements("option")
                        .Where(ele => ele.Attribute("value") != null && ele.Attribute("value").Value == op.Id.ToString())
                        .FirstOrDefault();

                    if (optionElement != null)
                    {
                        optionElement.SetAttributeValue("data-visible-if", visibleIfValue);
                        optionElement.SetAttributeValue("id", op.Id);
                        optionElement.SetAttributeValue("data-field-id", op.Id);
                    }
                }
            }
            selectHtmlString = xml.ToString();
        }


        @Html.Raw(selectHtmlString)
    }
}
