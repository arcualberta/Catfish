/**
 * Piranha Image plugin. This is a simple modification of the standard link
 * plugin included with TinyMCE.
 *
 * 2013-04-17   @tidyui
 */

tinymce.PluginManager.add('piranhaimage', function (editor) {
    function showDialog() {
        var win, data, dom = editor.dom, imgElm = editor.selection.getNode();
        var src, width, height;

        var dialog = new piranha.media('dummy', 'boxDialog', function (data) {
            var srcCtrl = win.find('#src')[0];
            srcCtrl.value(data.ContentUrl);
        });
        dialog.tinymce = true;
        dialog.filter = 'images';

        function mediaDialog(e) {
            dialog.buttonClick();
        }

        width = dom.getAttrib(imgElm, 'width');
        height = dom.getAttrib(imgElm, 'height');
        src = dom.getAttrib(imgElm, 'src');

        if (src.startsWith('/')) {
            var components = src.split('/');
            var pos = 0;

            for (pos = 0; pos < components.length; pos++) {
                console.log('loop');
                if (components[pos] == 'media') {
                    break;
                }
                if (pos == (components.length - 1)) {
                    pos = -1;
                    break;
                }
            }

            if (pos != -1 && components.length > (2 + pos)) {
                if (components[2 + pos] != 'x') {
                    width = components[2 + pos];
                }
                if (components.length > (3 + pos)) {
                    height = components[3 + pos];
                }
                src = components.slice(0, 2 + pos).join('/');
            }
        }

        if (imgElm.nodeName == "IMG" && !imgElm.getAttribute('data-mce-object')) {
            data = {
                src: src,
                alt: dom.getAttrib(imgElm, 'alt'),
                width: width,
                height: height
            };
        } else {
            imgElm = null;
        }

        win = editor.windowManager.open({
            title: "Edit image",
            data: data,
            body: [
                { 
                    type: 'container', 
                    label: 'Source', 
                    layout: 'flex',
                    direction: 'row', 
                    spacing: 5,
                    items: [
                        { name: 'src', type: 'textbox', autofocus: true, size: 27 },
                        { name: 'dialog', type: 'button', text: 'Browse', onclick: mediaDialog }
                    ]
                },
				{ name: 'alt', type: 'textbox', label: 'Image description' },
				{
				    type: 'container',
				    label: 'Dimensions',
				    layout: 'flex',
				    direction: 'row',
				    align: 'center',
				    spacing: 5,
				    items: [
						{ name: 'width', type: 'textbox', maxLength: 3, size: 3 },
						{ type: 'label', text: 'x' },
						{ name: 'height', type: 'textbox', maxLength: 3, size: 3 },
				    ]
				}
            ],
            onSubmit: function (e) {
                var data = e.data;

                // If this is an internal image, remove width & height and use
                // the internal scaling/cropping instead for better result.
                if (data.src.startsWith('/')) {
                    if (data.width != '') {
                        data.src += '/' + data.width;
                    } else if (data.height != '') {
                        data.src += '/x';
                    }
                    if (data.height != '') {
                        data.src += '/' + data.height;
                    }
 
                    delete data.width;
                    delete data.height;
                } else {
                    if (data.width === '') {
                        delete data.width;
                    }

                    if (data.height === '') {
                        delete data.height;
                    }
                }

                if (imgElm) {
                    dom.setAttribs(imgElm, data);
                } else {
                    editor.insertContent(dom.createHTML('img', data));
                }
            }
        });
    }

    editor.addButton('piranhaimage', {
        icon: 'image',
        tooltip: 'Insert/edit image',
        onclick: showDialog,
        stateSelector: 'img:not([data-mce-object])'
    });

    editor.addMenuItem('piranhaimage', {
        icon: 'image',
        text: 'Insert image',
        onclick: showDialog,
        context: 'insert',
        prependToContext: true
    });
});